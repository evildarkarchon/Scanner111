# Crash Log Formatting Service Documentation

## Overview

The `CrashLogFormattingService` is responsible for processing and reformatting crash log files generated by Buffout 4 (
or similar tools). This service provides functionality to:

1. Optionally remove common DLL references that are usually not relevant to the crash analysis
2. Format plugin load order entries consistently by replacing spaces with zeroes in the plugin index format
3. Convert and process crash log files both on disk and in memory
4. Automatically detect and validate crash logs
5. Create backups of files before modifying them

The service is directly ported from the Python's `crashlogs_reformat` function in the original CLASSIC tool, with
additional enhancements for error handling and usability.

## Key Features

### 1. Plugin Load Order Normalization

Normalizes plugin load order entries by replacing spaces within brackets with zeroes:

- `[ 1]` becomes `[01]`
- `[FE:  0]` becomes `[FE:000]`

This ensures consistency in plugin references across different Buffout 4 versions.

### 2. Log Simplification

When enabled, removes lines containing specified strings (like common system DLLs) to reduce log noise:

- Default strings to remove: `Steam.dll`, `nvwgf2umx.dll`, `KERNELBASE.dll`, `ntdll.dll`
- This list can be customized in the application settings and UI

### 3. File and Memory Processing

The service provides methods to:

- Process files on disk (`ReformatCrashLogsAsync`)
- Process log content in memory (`FormatCrashLogContent`)

### 4. Enhanced Error Handling

- Robust error detection and reporting for file access issues
- Tracking of processing errors in `AppSettings.LastProcessingErrors`
- Graceful handling of malformed plugin entries

### 5. Crash Log Validation

The `IsCrashLogAsync` method can validate if files contain actual crash log content by checking for common indicators
like:

- "Unhandled exception"
- "PLUGINS:" section
- "CRASH REASON:" section
- "STACK:" section

### 6. File Backup

When enabled, automatically creates backup copies of files with a `.bak` extension before modifying them.

## Usage

### Processing files on disk

```csharp
// Process multiple crash log files
int processedCount = await _formattingService.ReformatCrashLogsAsync(
    new[] { "crash-2023-05-01.log", "crash-2023-05-02.log" },
    _appSettings.SimplifyRemoveStrings
);
```

### Processing log content in memory

```csharp
// Format crash log content without modifying the file
string formattedContent = _formattingService.FormatCrashLogContent(
    originalLogContent,
    _appSettings.SimplifyRemoveStrings,
    _appSettings.SimplifyLogs
);
```

### Validating if a file contains crash log content

```csharp
// Check if a file appears to be a crash log
bool isCrashLog = await _formattingService.IsCrashLogAsync("suspicious-file.log");
```

### Integration with ScanLogService

The `ScanLogService` automatically uses the formatting service to preprocess logs before scanning them:

```csharp
// Scans logs with automatic preprocessing
var issues = await _scanLogService.ScanLogFileAsync("crash.log");

// Manually preprocess logs before scanning (if needed)
await _scanLogService.PreprocessCrashLogsAsync(new[] { "crash.log" });
```

## Settings

The following settings in `AppSettings` control the formatting behavior:

| Setting                 | Type           | Description                                                                                                |
|-------------------------|----------------|------------------------------------------------------------------------------------------------------------|
| `SimplifyLogs`          | `bool`         | When true, lines containing strings in `SimplifyRemoveStrings` will be removed                             |
| `SimplifyRemoveStrings` | `List<string>` | List of strings that, when found in a line, will cause that line to be removed (if `SimplifyLogs` is true) |
| `PreserveOriginalFiles` | `bool`         | When true, creates backup copies of files before modifying them                                            |
| `AutoDetectCrashLogs`   | `bool`         | When true, validates if files appear to be crash logs                                                      |
| `LastProcessingErrors`  | `List<string>` | Collection of error messages from the most recent processing operation                                     |

## Example

**Original log content:**

```
PLUGINS:
[ 1] DLCRobot.esm
[FE:  0] RedRocketsGlareII.esl
MODULES:
ntdll.dll
Steam.dll+0x12345
```

**After formatting (with SimplifyLogs=true):**

```
PLUGINS:
[01] DLCRobot.esm
[FE:000] RedRocketsGlareII.esl
MODULES:
```

## Implementation Details

- The service processes crash log files line by line in reverse order to maintain proper PLUGINS section detection
- Enhanced regex pattern matching for more accurate plugin entry detection
- Error handling ensures that if a line can't be parsed properly, it's preserved as-is
- The service handles both file I/O operations and in-memory string processing
- Comprehensive defensive programming techniques guard against various edge cases:
    - Empty or null inputs
    - Nonexistent files
    - Locked files
    - Malformed plugin entries
    - Missing section headers

## UI Integration

The `MainWindowViewModel` provides:

1. Settings controls for:
    - Enabling/disabling log simplification
    - Preserving original files
    - Auto-detecting crash logs

2. Management of DLL strings to remove:
    - View current DLL strings
    - Add new DLL strings
    - Remove existing DLL strings

3. Status updates:
    - Number of files processed
    - Error reporting
    - Warning for non-crash log files
